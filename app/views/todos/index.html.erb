<% content_for :title, "Todos" %>

<div class="w-full">
  <% if notice.present? %>
    <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice"><%= notice %></p>
  <% end %>

  <div class="flex justify-between items-center mb-6">
    <h1 class="font-bold text-4xl">Todos</h1>
    <div class="flex items-center space-x-3">
      <div class="hidden sm:flex items-center space-x-2">
        <span class="text-sm text-gray-500">Sort by:</span>
        <%= link_to "Position", todos_path(sort: 'position'), 
              class: "text-sm px-2 py-1 rounded #{(@sort == 'position') ? 'bg-gray-200 text-gray-900' : 'text-gray-600 hover:text-gray-900'}" %>
        <%= link_to "Due Date", todos_path(sort: 'due_date', direction: (@sort == 'due_date' && @direction == 'asc') ? 'desc' : 'asc'), 
              class: "text-sm px-2 py-1 rounded #{(@sort == 'due_date') ? 'bg-gray-200 text-gray-900' : 'text-gray-600 hover:text-gray-900'}" %>
        <% if @sort == 'due_date' %>
          <span class="text-xs text-gray-500">
            <%= @direction == 'asc' ? '↑' : '↓' %>
          </span>
        <% end %>
      </div>
      <%= link_to "New todo", new_todo_path, class: "rounded-md px-3.5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white block font-medium" %>
    </div>
  </div>
  
  <%= render "form", todo: @todo %>

  

  <!-- Mobile Card View -->
  <div class="block md:hidden">
    <% if @todos.any? %>
      <div class="divide-y divide-gray-200" 
           data-controller="sortable" 
           data-sortable-dragging-class="dragging">
        <% @todos.each do |todo| %>
          <div class="p-4 bg-white hover:bg-gray-50 transition-colors" 
               data-sortable-target="item" 
               data-todo-id="<%= todo.id %>"
               draggable="true"
               data-action="dragstart->sortable#dragstart dragend->sortable#dragend dragover->sortable#dragover drop->sortable#drop touchstart->sortable#touchstart touchmove->sortable#touchmove touchend->sortable#touchend">
            
            <!-- Drag Handle for Mobile -->
            <div class="sortable-handle flex items-center justify-between mb-3 cursor-move select-none" 
                 data-sortable-handle="true">
              <div class="flex items-center space-x-2">
                <div class="text-gray-400 hover:text-gray-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                  </svg>
                </div>
                <span class="text-xs text-gray-500 font-medium">Drag to reorder</span>
              </div>
              <% if todo.notes.any? %>
                <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2 py-1 rounded-full">
                  <%= todo.notes.count %> note<%= todo.notes.count == 1 ? '' : 's' %>
                </span>
              <% end %>
            </div>
            
<!-- Todo Content -->
             <div class="space-y-3">
               <!-- Completion Status -->
               <div class="flex items-center space-x-2">
                 <%= check_box_tag "todo_completed_#{todo.id}", 
                       todo.completed?, 
                       todo.completed?, 
                       class: "w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2",
                       data: { 
                         controller: "todo-completion",
                         action: "change->todo-completion#toggle",
                         todo_id: todo.id,
                         url: todo_path(todo)
                       } %>
                 <span class="text-sm font-medium <%= todo.completed? ? 'text-green-600' : 'text-gray-600' %>">
                   <%= todo.completed? ? "Completed" : "Pending" %>
                 </span>
               </div>
               
               <!-- Description -->
              <% if todo.description.present? %>
                <p class="text-sm text-gray-600 line-clamp-3"><%= todo.description %></p>
              <% end %>
              
              <!-- Due Date -->
              <% if todo.due_date.present? %>
                <div class="flex items-center text-sm">
                  <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 18h18M7 12h10"></path>
                  </svg>
                  <span class="text-gray-600"><%= todo.due_date.strftime("%b %d, %Y") %></span>
                  <% if todo.overdue? %>
                    <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 rounded-full">Overdue</span>
                  <% elsif todo.due_soon? %>
                    <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Due Soon</span>
                  <% end %>
                </div>
              <% end %>
              
              <!-- Action Buttons -->
              <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                <div class="flex items-center space-x-1">
                  <!-- View Button -->
                  <%= link_to todo, 
                        class: "flex items-center space-x-1 px-3 py-1.5 text-xs font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors", 
                        title: "View todo" do %>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <span>View</span>
                  <% end %>
                  
                  <!-- Edit Button -->
                  <%= link_to edit_todo_path(todo), 
                        class: "flex items-center space-x-1 px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors", 
                        title: "Edit todo" do %>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l17.586-8.586z"></path>
                    </svg>
                    <span>Edit</span>
                  <% end %>
                </div>
                
                <!-- Delete Button -->
                <%= button_to todo, 
                      method: :delete, 
                      class: "flex items-center space-x-1 px-3 py-1.5 text-xs font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors border-0 cursor-pointer", 
                      title: "Delete todo", 
                      data: { turbo_confirm: "Are you sure you want to delete this todo?" } do %>
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  <span>Delete</span>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="p-8 text-center">
        <div class="text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <p class="text-sm font-medium">No todos found</p>
          <p class="text-xs mt-1">Get started by creating your first todo.</p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Desktop Table View -->
  <div class="hidden md:block">
    <div class="bg-white shadow-sm rounded-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12"></th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Status</th>
               <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Description</th>
 
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">
                <%= link_to todos_path(sort: 'due_date', direction: (@sort == 'due_date' && @direction == 'asc') ? 'desc' : 'asc'), 
                      class: "flex items-center hover:text-gray-700 transition-colors" do %>
                  Due Date
                  <% if @sort == 'due_date' %>
                    <% if @direction == 'asc' %>
                      <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                      </svg>
                    <% else %>
                      <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    <% end %>
                  <% else %>
                    <svg class="ml-1 w-3 h-3 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                    </svg>
                  <% end %>
                <% end %>
              </th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Actions</th>
            </tr>
          </thead>
          <tbody id="todos" class="bg-white divide-y divide-gray-200" 
                 data-controller="sortable" 
                 data-sortable-dragging-class="dragging">
            <% if @todos.any? %>
              <% @todos.each do |todo| %>
                <tr class="hover:bg-gray-50 transition-colors cursor-move" 
                    data-sortable-target="item" 
                    data-todo-id="<%= todo.id %>"
                    draggable="true"
                    data-action="dragstart->sortable#dragstart dragend->sortable#dragend dragover->sortable#dragover drop->sortable#drop">
                  <td class="px-4 py-3 text-center">
                    <div class="sortable-handle text-gray-400 hover:text-gray-600">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                      </svg>
                    </div>
                  </td>
                   <td class="px-4 py-3">
                     <div class="flex items-center space-x-2">
                       <%= check_box_tag "todo_completed_#{todo.id}", 
                             todo.completed?, 
                             todo.completed?, 
                             class: "w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2",
                             data: { 
                               controller: "todo-completion",
                               action: "change->todo-completion#toggle",
                               todo_id: todo.id,
                               url: todo_path(todo)
                             } %>
                       <%# <span class="text-sm text-gray-600">
                         <%= todo.completed? ? "Completed" : "Pending" %>
                       <%# </span> %>
                     </div>
                   </td>
                   <td class="px-4 py-3">
                     <div class="text-sm text-gray-600 line-clamp-2" title="<%= todo.description %>">
                       <%= todo.description.present? ? todo.description : "<span class='text-gray-400 italic'>No description</span>".html_safe %>
                     </div>
                   </td>
                  <td class="px-4 py-3">
                     <% if todo.due_date.present? %>
                       <div class="flex items-center">
                         <%= todo.due_date.strftime("%b %d, %Y") %>
                         <% if todo.overdue? %>
                           <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 rounded">Overdue</span>
                         <% elsif todo.due_soon? %>
                           <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-800 rounded">Due Soon</span>
                         <% end %>
                       </div>
                     <% else %>
                       <div class="text-sm text-gray-400 italic">No due date</div>
                     <% end %>
                   </td>
                   <td class="px-4 py-3 text-right">
                  <div class="flex items-center justify-end space-x-1">
                        <!-- Notes Icon -->
                        <% if todo.notes.any? %>
                          <%= link_to todo, 
                                class: "bg-indigo-100 text-indigo-700 hover:bg-indigo-200 inline-flex items-center justify-center w-7 h-7 rounded-full transition-colors", 
                                title: "#{todo.notes.count} note#{todo.notes.count == 1 ? '' : 's'} attached" do %>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                          <% end %>
                        <% end %>
                        <!-- View Icon -->
                        <%= link_to todo,
                            class: "text-indigo-600 hover:text-indigo-900 inline-flex items-center justify-center w-7 h-7 rounded-full hover:bg-indigo-50 transition-colors", 
                            title: "View todo" do %>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                      <% end %>
                      
                      <!-- Edit Icon -->
                      <%= link_to edit_todo_path(todo), 
                            class: "text-blue-600 hover:text-blue-900 inline-flex items-center justify-center w-7 h-7 rounded-full hover:bg-blue-50 transition-colors", 
                            title: "Edit todo" do %>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l17.586-8.586z"></path>
                        </svg>
                      <% end %>
                      
                      <!-- Delete Icon -->
                      <%= button_to todo, 
                            method: :delete, 
                            class: "text-red-600 hover:text-red-900 inline-flex items-center justify-center w-7 h-7 rounded-full hover:bg-red-50 transition-colors border-0 bg-transparent cursor-pointer p-0", 
                            title: "Delete todo", 
                            data: { turbo_confirm: "Are you sure you want to delete this todo?" } do %>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="5" class="px-6 py-12 text-center">
                  <div class="text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <p class="text-sm font-medium">No todos found</p>
                    <p class="text-xs mt-1">Get started by creating your first todo.</p>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
